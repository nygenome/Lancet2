#include "lancet/hts/phred_quality.h"

#include <array>
#include <cmath>

namespace lancet::hts {

// clang-format off
static constexpr auto LUT_PHRED_TO_ERROR_PROB = std::array<f64, MAX_PHRED_SCORE + 1>{
  1, 0.7943282347242815020659182828, 0.6309573444801932494343601366, 0.5011872336272722850015541869,
  0.3981071705534972507702523051, 0.3162277660168379331998893544, 0.2511886431509580111085032068,
  0.1995262314968879601352455397, 0.1584893192461113485202101373, 0.1258925411794167210423954106,
  0.1, 0.07943282347242815020659182828, 0.06309573444801932494343601366, 0.05011872336272722850015541869,
  0.03981071705534972507702523051, 0.03162277660168379331998893544, 0.02511886431509580111085032068,
  0.01995262314968879601352455397, 0.01584893192461113485202101373, 0.01258925411794167210423954106,
  0.01, 0.007943282347242815020659182828, 0.006309573444801932494343601366, 0.005011872336272722850015541869,
  0.003981071705534972507702523051, 0.003162277660168379331998893544, 0.002511886431509580111085032068,
  0.001995262314968879601352455397, 0.001584893192461113485202101373, 0.001258925411794167210423954106,
  0.001, 0.0007943282347242815020659182828, 0.0006309573444801932494343601366, 0.0005011872336272722850015541869,
  0.0003981071705534972507702523051, 0.0003162277660168379331998893544, 0.0002511886431509580111085032068,
  0.0001995262314968879601352455397, 0.0001584893192461113485202101373, 0.0001258925411794167210423954106,
  0.0001, 0.00007943282347242815020659182828, 0.00006309573444801932494343601366, 0.00005011872336272722850015541869,
  0.00003981071705534972507702523051, 0.00003162277660168379331998893544, 0.00002511886431509580111085032068,
  0.00001995262314968879601352455397, 0.00001584893192461113485202101373, 0.00001258925411794167210423954106,
  0.00001, 0.000007943282347242815020659182828, 0.000006309573444801932494343601366,
  0.000005011872336272722850015541869, 0.000003981071705534972507702523051, 0.000003162277660168379331998893544,
  0.000002511886431509580111085032068, 0.000001995262314968879601352455397, 0.000001584893192461113485202101373,
  0.000001258925411794167210423954106, 0.000001, 7.943282347242815020659182828E-7, 6.309573444801932494343601366E-7,
  5.011872336272722850015541869E-7, 3.981071705534972507702523051E-7, 3.162277660168379331998893544E-7,
  2.511886431509580111085032068E-7, 1.995262314968879601352455397E-7, 1.584893192461113485202101373E-7,
  1.258925411794167210423954106E-7, 1E-7, 7.943282347242815020659182828E-8, 6.309573444801932494343601366E-8,
  5.011872336272722850015541869E-8, 3.981071705534972507702523051E-8, 3.162277660168379331998893544E-8,
  2.511886431509580111085032068E-8, 1.995262314968879601352455397E-8, 1.584893192461113485202101373E-8,
  1.258925411794167210423954106E-8, 1E-8, 7.943282347242815020659182828E-9, 6.309573444801932494343601366E-9,
  5.011872336272722850015541869E-9, 3.981071705534972507702523051E-9, 3.162277660168379331998893544E-9,
  2.511886431509580111085032068E-9, 1.995262314968879601352455397E-9, 1.584893192461113485202101373E-9,
  1.258925411794167210423954106E-9, 1E-9, 7.943282347242815020659182828E-10, 6.309573444801932494343601366E-10,
  5.011872336272722850015541869E-10, 3.981071705534972507702523051E-10, 3.162277660168379331998893544E-10,
  2.511886431509580111085032068E-10, 1.995262314968879601352455397E-10, 1.584893192461113485202101373E-10,
  1.258925411794167210423954106E-10, 1E-10, 7.943282347242815020659182828E-11, 6.309573444801932494343601366E-11,
  5.011872336272722850015541869E-11, 3.981071705534972507702523051E-11, 3.162277660168379331998893544E-11,
  2.511886431509580111085032068E-11, 1.995262314968879601352455397E-11, 1.584893192461113485202101373E-11,
  1.258925411794167210423954106E-11, 1E-11, 7.943282347242815020659182828E-12, 6.309573444801932494343601366E-12,
  5.011872336272722850015541869E-12, 3.981071705534972507702523051E-12, 3.162277660168379331998893544E-12,
  2.511886431509580111085032068E-12, 1.995262314968879601352455397E-12, 1.584893192461113485202101373E-12,
  1.258925411794167210423954106E-12, 1E-12, 7.943282347242815020659182828E-13, 6.309573444801932494343601366E-13,
  5.011872336272722850015541869E-13, 3.981071705534972507702523051E-13, 3.162277660168379331998893544E-13,
  2.511886431509580111085032068E-13, 1.995262314968879601352455397E-13, 1.584893192461113485202101373E-13,
  1.258925411794167210423954106E-13, 1E-13, 7.943282347242815020659182828E-14, 6.309573444801932494343601366E-14,
  5.011872336272722850015541869E-14, 3.981071705534972507702523051E-14, 3.162277660168379331998893544E-14,
  2.511886431509580111085032068E-14, 1.995262314968879601352455397E-14, 1.584893192461113485202101373E-14,
  1.258925411794167210423954106E-14, 1E-14, 7.943282347242815020659182828E-15, 6.309573444801932494343601366E-15,
  5.011872336272722850015541869E-15, 3.981071705534972507702523051E-15, 3.162277660168379331998893544E-15,
  2.511886431509580111085032068E-15, 1.995262314968879601352455397E-15, 1.584893192461113485202101373E-15,
  1.258925411794167210423954106E-15, 1E-15, 7.943282347242815020659182828E-16, 6.309573444801932494343601366E-16,
  5.011872336272722850015541869E-16, 3.981071705534972507702523051E-16, 3.162277660168379331998893544E-16,
  2.511886431509580111085032068E-16, 1.995262314968879601352455397E-16, 1.584893192461113485202101373E-16,
  1.258925411794167210423954106E-16, 1E-16, 7.943282347242815020659182828E-17, 6.309573444801932494343601366E-17,
  5.011872336272722850015541869E-17, 3.981071705534972507702523051E-17, 3.162277660168379331998893544E-17,
  2.511886431509580111085032068E-17, 1.995262314968879601352455397E-17, 1.584893192461113485202101373E-17,
  1.258925411794167210423954106E-17, 1E-17, 7.943282347242815020659182828E-18, 6.309573444801932494343601366E-18,
  5.011872336272722850015541869E-18, 3.981071705534972507702523051E-18, 3.162277660168379331998893544E-18,
  2.511886431509580111085032068E-18, 1.995262314968879601352455397E-18, 1.584893192461113485202101373E-18,
  1.258925411794167210423954106E-18, 1E-18, 7.943282347242815020659182828E-19, 6.309573444801932494343601366E-19,
  5.011872336272722850015541869E-19, 3.981071705534972507702523051E-19, 3.162277660168379331998893544E-19,
  2.511886431509580111085032068E-19, 1.995262314968879601352455397E-19, 1.584893192461113485202101373E-19,
  1.258925411794167210423954106E-19, 1E-19, 7.943282347242815020659182828E-20, 6.309573444801932494343601366E-20,
  5.011872336272722850015541869E-20, 3.981071705534972507702523051E-20, 3.162277660168379331998893544E-20,
  2.511886431509580111085032068E-20, 1.995262314968879601352455397E-20, 1.584893192461113485202101373E-20,
  1.258925411794167210423954106E-20, 1E-20, 7.943282347242815020659182828E-21, 6.309573444801932494343601366E-21,
  5.011872336272722850015541869E-21, 3.981071705534972507702523051E-21, 3.162277660168379331998893544E-21,
  2.511886431509580111085032068E-21, 1.995262314968879601352455397E-21, 1.584893192461113485202101373E-21,
  1.258925411794167210423954106E-21, 1E-21, 7.943282347242815020659182828E-22, 6.309573444801932494343601366E-22,
  5.011872336272722850015541869E-22, 3.981071705534972507702523051E-22, 3.162277660168379331998893544E-22,
  2.511886431509580111085032068E-22, 1.995262314968879601352455397E-22, 1.584893192461113485202101373E-22,
  1.258925411794167210423954106E-22, 1E-22, 7.943282347242815020659182828E-23, 6.309573444801932494343601366E-23,
  5.011872336272722850015541869E-23, 3.981071705534972507702523051E-23, 3.162277660168379331998893544E-23,
  2.511886431509580111085032068E-23, 1.995262314968879601352455397E-23, 1.584893192461113485202101373E-23,
  1.258925411794167210423954106E-23, 1E-23, 7.943282347242815020659182828E-24, 6.309573444801932494343601366E-24,
  5.011872336272722850015541869E-24, 3.981071705534972507702523051E-24, 3.162277660168379331998893544E-24,
  2.511886431509580111085032068E-24, 1.995262314968879601352455397E-24, 1.584893192461113485202101373E-24,
  1.258925411794167210423954106E-24, 1E-24, 7.943282347242815020659182828E-25, 6.309573444801932494343601366E-25,
  5.011872336272722850015541869E-25, 3.981071705534972507702523051E-25, 3.162277660168379331998893544E-25,
  2.511886431509580111085032068E-25, 1.995262314968879601352455397E-25, 1.584893192461113485202101373E-25,
  1.258925411794167210423954106E-25, 1E-25, 7.943282347242815020659182828E-26, 6.309573444801932494343601366E-26,
  5.011872336272722850015541869E-26, 3.981071705534972507702523051E-26, 3.162277660168379331998893544E-26
};
// clang-format on

auto PhredToErrorProb(u32 phred_score) -> f64 {
  const auto idx = phred_score > MAX_PHRED_SCORE ? MAX_PHRED_SCORE : static_cast<usize>(phred_score);
  return LUT_PHRED_TO_ERROR_PROB.at(idx);
}

auto ErrorProbToPhred(f64 prob) -> f64 {
  if (prob == 1.0) return 0;                // NOLINT(readability-braces-around-statements)
  if (prob == 0.0) return MAX_PHRED_SCORE;  // NOLINT(readability-braces-around-statements)
  static constexpr f64 PHRED_MULTIPLIER = -10.0;
  return std::round(PHRED_MULTIPLIER * std::log10(prob));
}

}  // namespace lancet::hts
